<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XInput 手柄震动测试</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1, h2 { margin-top: 20px; }
    .slider-container { margin: 15px 0; }
    label { display: block; margin-bottom: 5px; }
    #stopBtn { margin-top: 10px; padding: 8px 16px; }
    #gamepadInfo p { margin: 4px 0; }
  </style>
</head>
<body>
  <h1>XInput 手柄震动测试</h1>
  <div id="status">等待手柄连接...</div>

  <div class="slider-container">
    <label for="leftSlider">左侧震动 (低频): <span id="leftValue">0</span></label>
    <input type="range" id="leftSlider" min="0" max="65535" step="1" value="0">
  </div>
  <div class="slider-container">
    <label for="rightSlider">右侧震动 (高频): <span id="rightValue">0</span></label>
    <input type="range" id="rightSlider" min="0" max="65535" step="1" value="0">
  </div>
  <button id="stopBtn">停止震动</button>

  <h2>手柄状态</h2>
  <div id="gamepadInfo">--</div>

  <script>
    let gpIndex = null;

    window.addEventListener('gamepadconnected', (e) => {
      gpIndex = e.gamepad.index;
      document.getElementById('status').textContent = `已连接: ${e.gamepad.id}`;
    });

    window.addEventListener('gamepaddisconnected', (e) => {
      if (gpIndex === e.gamepad.index) {
        gpIndex = null;
        document.getElementById('status').textContent = '手柄已断开';
      }
    });

    function sendVibration(weak, strong) {
      if (gpIndex === null) return;
      const gp = navigator.getGamepads()[gpIndex];
      if (gp && gp.vibrationActuator && gp.vibrationActuator.type === 'dual-rumble') {
        gp.vibrationActuator.playEffect('dual-rumble', {
          duration: 1000,
          weakMagnitude: weak,
          strongMagnitude: strong
        });
      }
    }

    document.getElementById('leftSlider').addEventListener('input', (e) => {
      const val = Number(e.target.value);
      document.getElementById('leftValue').textContent = val;
      const leftMag  = val / 65535;
      const rightMag = Number(document.getElementById('rightSlider').value) / 65535;
      sendVibration(leftMag, rightMag);
    });

    document.getElementById('rightSlider').addEventListener('input', (e) => {
      const val = Number(e.target.value);
      document.getElementById('rightValue').textContent = val;
      const leftMag  = Number(document.getElementById('leftSlider').value) / 65535;
      const rightMag = val / 65535;
      sendVibration(leftMag, rightMag);
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      document.getElementById('leftSlider').value = 0;
      document.getElementById('rightSlider').value = 0;
      document.getElementById('leftValue').textContent = '0';
      document.getElementById('rightValue').textContent = '0';
      sendVibration(0, 0);
    });

    function updateStatus() {
      if (gpIndex !== null) {
        const gp = navigator.getGamepads()[gpIndex];
        if (gp) {
          const infoEl = document.getElementById('gamepadInfo');
          let html = `<p>ID: ${gp.id}</p>`;
          html += `<p>Axes: ${gp.axes.map(a => a.toFixed(2)).join(', ')}</p>`;
          html += `<p>Buttons Pressed: ${gp.buttons.map((b, i) => b.pressed ? i : null).filter(i => i !== null).join(', ') || '无'}</p>`;
          infoEl.innerHTML = html;
        }
      }
      requestAnimationFrame(updateStatus);
    }
    requestAnimationFrame(updateStatus);
  </script>
</body>
</html>
